flowchart TD
    A[ðŸ” User Requests to Download File] --> B{âœ… Role Check}

    B -->|âœ… Has Permission| C[ðŸ“¦ Locate File by Document ID]
    B -->|âŒ Unauthorized| B1[â›” Show Access Denied Message]

    C --> D{ðŸ“ Where is the File?}
    D -->|In Database| E1[â¬‡ï¸ Fetch from DB]
    D -->|In S3 Bucket| E2[â¬‡ï¸ Download from S3]

    E1 --> F[ðŸ“¤ Generate Excel Stream]
    E2 --> F

    F --> G{ðŸ§¾ Add Headers}
    G --> H[Content-Disposition: attachment]
    G --> I[Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet]

    H --> J[ðŸ“ Send File to Browser]
    I --> J
    J --> K[âœ… User Downloads the File]
